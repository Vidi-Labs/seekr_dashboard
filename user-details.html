<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
        }
        #sideNav {
            width: 250px;
            background-color: #f8f9fa;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            border-right: 1px solid #dee2e6;
        }
        #content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Side Navigation -->
    <div id="sideNav">
        <h5 class="text-center">Analytics Dashboard</h5>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#">User Details</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/settings">Settings</a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div id="content">
        <h4>User Details</h4>

        <!-- Feature Analytics Section -->
        <div>
            <label for="timeRangeDropdown" class="form-label">Select Time Range:</label>
            <select class="form-select mb-3" id="timeRangeDropdown" onchange="fetchFeatureCounts()">
                <option value="LAST_WEEK">Last Week</option>
                <option value="LAST_MONTH">Last Month</option>
                <option value="CUSTOM">Custom Range</option>
            </select>
            <div id="customDateRange" style="display:none;">
                <label>From:</label>
                <input type="date" id="startDate" class="form-control mb-2">
                <label>To:</label>
                <input type="date" id="endDate" class="form-control mb-2">
            </div>
            <canvas id="featureCountChart" class="mb-4"></canvas>
        </div>

        <!-- User Details Button -->
        <button class="btn btn-primary" onclick="fetchUserDetails(userId)">View User Details</button>

        <!-- User Details Modal -->
        <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">User Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="spinner" class="d-flex justify-content-center mb-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="userDetailsContent" class="d-none">
                            <h6>User Information</h6>
                            <table class="table table-striped">
                                <tr><th>User ID:</th><td id="userId"></td></tr>
                                <tr><th>Name:</th><td id="userName"></td></tr>
                                <tr><th>Email:</th><td id="userEmail"></td></tr>
                                <tr><th>Phone:</th><td id="userPhoneNumber"></td></tr>
                                <tr><th>Anonymous:</th><td id="userIsAnonymous"></td></tr>
                            </table>
                            <h6>Device Information</h6>
                            <table class="table table-striped">
                                <tr><th>Device Name:</th><td id="deviceName"></td></tr>
                                <tr><th>Model:</th><td id="deviceModel"></td></tr>
                                <tr><th>System Name:</th><td id="systemName"></td></tr>
                                <tr><th>System Version:</th><td id="systemVersion"></td></tr>
                            </table>
                            <h6>Usage Time</h6>
                            <table class="table table-striped">
                                <tr><th>From:</th><td id="usageFrom"></td></tr>
                                <tr><th>To:</th><td id="usageTo"></td></tr>
                            </table>
                            <h6>Location</h6>
                            <table class="table table-striped">
                                <tr><th>Latitude:</th><td id="locationLat"></td></tr>
                                <tr><th>Longitude:</th><td id="locationLon"></td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Extract userId from query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');

        if (!userId) {
            alert('User ID not found!');
            window.location.href = '/';
        }

        document.getElementById('timeRangeDropdown').addEventListener('change', () => {
            const selectedValue = document.getElementById('timeRangeDropdown').value;
            document.getElementById('customDateRange').style.display = selectedValue === 'CUSTOM' ? 'block' : 'none';
        });

        // Fetch feature counts
        async function fetchFeatureCounts() {
            const dropdown = document.getElementById('timeRangeDropdown');
            const selectedValue = dropdown.value;

            const payload = { lastActivity: selectedValue };
            if (selectedValue === 'CUSTOM') {
                payload.dateRange = {
                    from: document.getElementById('startDate').value,
                    to: document.getElementById('endDate').value,
                };
            }

            try {
                const response = await fetch(`https://seekr-analytics.squadhead.workers.dev/analytics/users/${userId}/features`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (data.success) {
                    updateFeatureCountChart(data.data.features);
                } else {
                    console.error('Failed to fetch feature counts:', data.message);
                }
            } catch (error) {
                console.error('Error fetching feature counts:', error);
            }
        }

        function updateFeatureCountChart(features) {
            const ctx = document.getElementById('featureCountChart').getContext('2d');
            const labels = [...new Set(features.map(f => new Date(f.createdAt).toLocaleDateString()))];
            const dataset = features.map(f => ({ x: new Date(f.createdAt).toLocaleDateString(), y: 1 }));

            if (window.featureChart) window.featureChart.destroy();

            window.featureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Features',
                            data: dataset.map(d => d.y),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        },
                    ],
                },
            });
        }

        // Fetch user details
        async function fetchUserDetails(userId) {
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            document.getElementById('spinner').classList.remove('d-none');
            document.getElementById('userDetailsContent').classList.add('d-none');
            modal.show();

            try {
                const response = await fetch(`https://seekr-analytics.squadhead.workers.dev/analytics/users/${userId}`);
                const data = await response.json();
                if (data.success) {
                    const { user, device, ussageTime: usageTime, location } = data.data;

                    document.getElementById('userId').textContent = user.uid ?? '';
                    document.getElementById('userName').textContent = user.name ?? 'N/A';
                    document.getElementById('userEmail').textContent = user.email ?? 'N/A';
                    document.getElementById('userPhoneNumber').textContent = user.phoneNumber ?? 'N/A';
                    document.getElementById('userIsAnonymous').textContent = user.isAnonymous ? 'Yes' : 'No';

                    document.getElementById('deviceName').textContent = device.name ?? 'N/A';
                    document.getElementById('deviceModel').textContent = device.model ?? 'N/A';
                    document.getElementById('systemName').textContent = device.systemName ?? 'N/A';
                    document.getElementById('systemVersion').textContent = device.systemVersion ?? 'N/A';

                    document.getElementById('usageFrom').textContent = usageTime.from ? new Date(usageTime.from).toLocaleString() : 'N/A';
                    document.getElementById('usageTo').textContent = usageTime.to ? new Date(usageTime.to).toLocaleString() : 'N/A';

                    document.getElementById('locationLat').textContent = location.lat ?? 'N/A';
                    document.getElementById('locationLon').textContent = location.lon ?? 'N/A';

                    document.getElementById('spinner').classList.add('d-none');
                    document.getElementById('userDetailsContent').classList.remove('d-none');
                } else {
                    console.error('Failed to fetch user details:', data.message);
                    modal.hide();
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
                modal.hide();
            }
        }

        // Fetch initial data
        fetchFeatureCounts();
    </script>
</body>
</html>
